# Ralph Progress Log
Started: Wed Jan 14 16:32:15 PST 2026
---

## Codebase Patterns
- html2canvas 1.4.1 has built-in types, do NOT install @types/html2canvas (causes type conflicts)
- Storage utils were refactored from x/y position to corner-based positioning (saveCorner/loadCorner)
- Widget uses corner snapping: bottom-right, bottom-left, top-right, top-left
- Screenshot utilities are in src/components/FeedbackWidget/utils/screenshot.ts
- Selection mode uses canvas-based lasso drawing instead of DOM element highlighting
- Canvas overlay is in Shadow DOM; update counter/warning text in-place to avoid destroying event listeners
- DrawnRectangle interface tracks x, y, width, height, id, number for each lasso region

---

## 2026-01-14 16:35 - STORY-018
- What was implemented:
  - Installed html2canvas library for screen capture
  - Created screenshot.ts utility module with CapturedScreenshot interface
  - captureRegion(x, y, width, height) returns Promise<Blob>
  - captureScreenshot() returns full CapturedScreenshot object with blob URL
  - Validation: regions < 10x10 throw "Selection too small"
  - Regions > 2000px in either dimension are scaled down proportionally
- Files changed:
  - package.json - added html2canvas dependency
  - src/components/FeedbackWidget/utils/screenshot.ts - new file
  - tests/unit/screenshot.test.ts - new file with 15 tests
  - tests/unit/widget.test.ts - fixed pre-existing storage tests to use corner API
- **Learnings for future iterations:**
  - html2canvas 1.4.1 ships with its own TypeScript types in dist/types/
  - @types/html2canvas is for version 0.5 and conflicts with modern html2canvas types
  - The storage.ts API was refactored from position-based to corner-based in STORY-017
  - html2canvas options x, y, width, height are in RenderOptions interface
---

## 2026-01-14 16:45 - STORY-019
- What was implemented:
  - Rewrote SelectionMode.tsx to use full-viewport canvas overlay
  - Canvas has crosshair cursor and is transparent
  - Mousedown/mousemove/mouseup draws lasso rectangles
  - Rectangle styling: Sonance blue (#00A3E1) 2px border, 20% opacity fill
  - Numbered badges drawn on canvas at top-left of each completed rectangle
  - Maximum 5 rectangles with warning when limit exceeded
  - ESC key cancels and exits selection mode
  - Done button exits selection mode
  - Screenshot capture triggers on mouseup with valid region
  - Updated index.tsx to manage capturedScreenshots and drawnRectangles state
  - Counter updates in-place without destroying canvas/event listeners
- Files changed:
  - src/components/FeedbackWidget/SelectionMode.tsx - complete rewrite for canvas
  - src/components/FeedbackWidget/index.tsx - replaced element selection with screenshot capture
  - tests/e2e/feedback-flow.spec.ts - updated tests for canvas-based selection
- **Learnings for future iterations:**
  - When updating Shadow DOM content, avoid replacing entire overlay to preserve canvas and listeners
  - Use querySelector to find and update specific text elements (counter, warnings) instead
  - html2canvas may fail silently in headless browsers; E2E tests should be lenient about counter value
  - canvasUtils.normalizeRect() handles negative width/height from dragging any direction
---
