{
  "branchName": "ralph/lasso-screenshot",
  "stories": [
    {
      "id": "STORY-001",
      "title": "Project setup and dependencies",
      "priority": 1,
      "passes": true,
      "description": "Install and configure all required dependencies for the feedback widget project including Supabase client, Lucide React icons, Vitest for unit testing, and Playwright for E2E testing.",
      "acceptanceCriteria": [
        "Supabase client (@supabase/supabase-js) is installed",
        "Lucide React (lucide-react) is installed",
        "Vitest is installed and configured with npm run test script",
        "Playwright is installed and configured with npm run test:e2e script",
        ".env.example file exists with NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY placeholders",
        "npm run test runs without errors (even if no tests exist yet)",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-002",
      "title": "Supabase schema migration",
      "priority": 2,
      "passes": true,
      "description": "Create SQL migration file for the feedback table with proper schema and Row Level Security policies.",
      "acceptanceCriteria": [
        "supabase/migrations/ directory exists",
        "Migration file 001_feedback_table.sql exists",
        "Schema includes: id (uuid primary key), app_id (text not null), type (text), message (text not null), elements (jsonb nullable), metadata (jsonb), created_at (timestamptz)",
        "RLS policy allows public INSERT",
        "RLS policy allows authenticated SELECT",
        "SQL syntax is valid"
      ]
    },
    {
      "id": "STORY-003",
      "title": "Demo page with sample UI",
      "priority": 3,
      "passes": true,
      "description": "Create a demo page at /demo with various interactive elements to test the element selection feature of the feedback widget.",
      "acceptanceCriteria": [
        "src/app/demo/page.tsx exists",
        "Page includes buttons, links, and form inputs",
        "Page includes card-like components",
        "Page includes navigation elements",
        "Page is styled with Tailwind CSS",
        "Page renders without errors at http://localhost:3000/demo",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-004",
      "title": "Basic widget shell with Shadow DOM",
      "priority": 4,
      "passes": true,
      "description": "Create the FeedbackWidget component using Shadow DOM for style isolation. The widget should render as a circular button with a MessageSquare icon and show 'Feedback' tooltip on hover. Query the sonance-brand MCP for brand colors.",
      "acceptanceCriteria": [
        "src/components/FeedbackWidget/index.tsx exists",
        "Component uses Shadow DOM for style isolation",
        "Collapsed state shows circular button with MessageSquare icon from Lucide",
        "Tooltip shows 'Feedback' text on hover",
        "Widget is fixed position (default: bottom-right corner)",
        "Styles are defined in src/components/FeedbackWidget/styles.ts",
        "Colors are sourced from sonance-brand MCP",
        "Widget renders on demo page without CSS conflicts",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-005",
      "title": "Draggable widget with position persistence",
      "priority": 5,
      "passes": true,
      "description": "Implement drag functionality on the widget button so users can reposition it. Position should persist in localStorage and restore on page load.",
      "acceptanceCriteria": [
        "Widget button can be dragged to any position on screen",
        "Position is saved to localStorage with key 'feedback-widget-position'",
        "Position is restored from localStorage on component mount",
        "Widget stays within viewport bounds (cannot be dragged off-screen)",
        "src/components/FeedbackWidget/utils/storage.ts contains localStorage helpers",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-006",
      "title": "Expandable feedback form",
      "priority": 6,
      "passes": true,
      "description": "Implement the expanded form state with feedback type dropdown, message textarea, submit button, and close button.",
      "acceptanceCriteria": [
        "Clicking widget button expands to show form panel",
        "Form includes type dropdown with options: Bug, Feature, General",
        "Form includes message textarea",
        "Form includes Submit button",
        "Form includes Close button (X) to collapse back to button",
        "src/components/FeedbackWidget/FeedbackForm.tsx exists",
        "Form is styled within Shadow DOM",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-007",
      "title": "Supabase submission integration",
      "priority": 7,
      "passes": true,
      "description": "Connect the feedback form to Supabase for data submission. Include metadata capture and JWT detection for user identification.",
      "acceptanceCriteria": [
        "src/lib/supabase.ts exists with Supabase client setup using env variables",
        "Submit button sends feedback to Supabase feedback table",
        "Metadata is auto-captured: URL (window.location.href), userAgent, timestamp",
        "src/components/FeedbackWidget/utils/jwt.ts detects userId from cookies and localStorage",
        "JWT detection is configurable (which keys to check)",
        "Loading state shows during submission",
        "Success state shows after submission with auto-collapse after 2 seconds",
        "Error state shows on failure with error message",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-008",
      "title": "Unit tests for core widget",
      "priority": 8,
      "passes": true,
      "description": "Write unit tests for the core widget functionality using Vitest.",
      "acceptanceCriteria": [
        "tests/unit/widget.test.ts exists",
        "Test for widget render",
        "Test for form validation (message required)",
        "Test for position persistence logic (storage utils)",
        "Test for JWT detection utility",
        "All tests pass with npm run test",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-009",
      "title": "Selection mode overlay",
      "priority": 9,
      "passes": true,
      "description": "Implement the selection mode UI with darkened overlay and crosshair cursor when user wants to select elements on screen.",
      "acceptanceCriteria": [
        "Form includes 'Select on Screen' button",
        "Clicking button activates selection mode",
        "Selection mode shows darkened overlay covering the page",
        "Cursor changes to crosshair in selection mode",
        "ESC key exits selection mode",
        "Clicking the widget button exits selection mode",
        "'Done' button appears to exit selection mode",
        "src/components/FeedbackWidget/SelectionMode.tsx exists",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-010",
      "title": "Interactive element highlighting",
      "priority": 10,
      "passes": true,
      "description": "In selection mode, detect and highlight interactive elements (buttons, links, inputs, elements with roles or click handlers) on hover.",
      "acceptanceCriteria": [
        "Interactive elements are detected: buttons, links, inputs, [role], [onclick], elements with tabindex",
        "Hovering over interactive elements shows highlight outline",
        "Non-interactive elements do not highlight",
        "src/components/FeedbackWidget/utils/elements.ts contains element detection logic",
        "Highlighting is visually distinct (e.g., colored outline)",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-011",
      "title": "Multi-element selection with limit",
      "priority": 11,
      "passes": true,
      "description": "Allow users to click to select/deselect multiple elements (up to 5) and capture rich data about each selected element.",
      "acceptanceCriteria": [
        "Clicking an interactive element selects it",
        "Clicking a selected element deselects it",
        "Selected elements show numbered badge overlay (1, 2, 3...)",
        "Counter shows 'X/5 selected' during selection mode",
        "Maximum 5 elements can be selected (additional clicks show warning)",
        "Rich data captured for each element: CSS selector, innerText (truncated), tagName, className, bounding box coordinates",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-012",
      "title": "Selected elements UI in form",
      "priority": 12,
      "passes": true,
      "description": "Display selected elements in the feedback form as an expandable list with remove functionality.",
      "acceptanceCriteria": [
        "src/components/FeedbackWidget/ElementList.tsx exists",
        "When collapsed: shows 'X elements selected' badge",
        "Clicking badge expands to show list of elements",
        "Each element shows preview (tagName, truncated text)",
        "Each element has remove button",
        "'Clear all' option available",
        "Elements data is included in Supabase submission",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-013",
      "title": "E2E tests for element selection flow",
      "priority": 13,
      "passes": true,
      "description": "Write Playwright E2E tests covering the full element selection and feedback submission flow.",
      "acceptanceCriteria": [
        "tests/e2e/feedback-flow.spec.ts exists",
        "Test: widget renders on demo page",
        "Test: form opens and closes",
        "Test: enter selection mode and select elements",
        "Test: remove element from selection",
        "Test: submit feedback with selected elements",
        "All E2E tests pass with npm run test:e2e",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-014",
      "title": "Widget configuration API",
      "priority": 14,
      "passes": true,
      "description": "Implement FeedbackWidget.init() configuration API for host applications to customize the widget.",
      "acceptanceCriteria": [
        "FeedbackWidget.init() accepts configuration object",
        "appId is required (throws error if missing)",
        "position is optional (default: bottom-right), accepts: bottom-right, bottom-left, top-right, top-left",
        "jwtConfig is optional to override JWT detection settings",
        "Invalid config shows clear error message",
        "Demo page uses init() with appId: 'demo-app'",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-015",
      "title": "Error handling and edge cases",
      "priority": 15,
      "passes": true,
      "description": "Add robust error handling for Supabase connection issues, missing configuration, and form validation.",
      "acceptanceCriteria": [
        "Supabase connection errors show user-friendly message",
        "Missing env variables show clear error in console",
        "Form validates message field is not empty before submission",
        "Empty message shows validation error",
        "Network errors offer retry option",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-016",
      "title": "Documentation and usage guide",
      "priority": 16,
      "passes": true,
      "description": "Create comprehensive README with installation instructions, configuration options, and Supabase setup guide.",
      "acceptanceCriteria": [
        "README.md exists with project overview",
        "Installation instructions (git clone, npm install)",
        "Environment setup instructions (.env.local)",
        "Supabase setup guide (how to run migrations)",
        "Configuration options documented (appId, position, jwtConfig)",
        "Example integration code snippet",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-017",
      "title": "Morph animation and corner snapping",
      "priority": 17,
      "passes": true,
      "description": "Implement smooth morph animation where the circular button transforms into the form panel. Add corner snapping so the widget automatically snaps to the nearest viewport corner when dragged, with directional expansion toward the center.",
      "acceptanceCriteria": [
        "Widget button morphs into form panel with smooth CSS transitions",
        "Form panel morphs back to button when closed",
        "Widget snaps to nearest viewport corner (bottom-right, bottom-left, top-right, top-left) when drag ends",
        "Snap animation is smooth with bouncy easing",
        "Form expands toward center based on corner position (e.g., bottom-right expands up-left)",
        "Widget stays anchored to corner on window resize",
        "Sonance brand colors applied (#00A3E1)",
        "All existing E2E tests pass",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-018",
      "title": "Install html2canvas and screenshot utility",
      "priority": 18,
      "passes": true,
      "description": "Install html2canvas library and create a screenshot utility module that wraps html2canvas for capturing screen regions.",
      "acceptanceCriteria": [
        "html2canvas is installed as a dependency (npm install html2canvas)",
        "@types/html2canvas is installed for TypeScript support",
        "src/components/FeedbackWidget/utils/screenshot.ts exists",
        "screenshot.ts exports CapturedScreenshot interface with: id, blobUrl, region (x,y,width,height), capturedAt, sizeBytes",
        "screenshot.ts exports captureRegion(x, y, width, height) function that returns Promise<Blob>",
        "captureRegion uses html2canvas with useCORS: true and logging: false",
        "Regions smaller than 10x10 pixels throw error 'Selection too small'",
        "Regions larger than 2000px in either dimension are scaled down proportionally",
        "Unit test in tests/unit/screenshot.test.ts verifies captureRegion interface",
        "npm run test passes",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-019",
      "title": "Lasso rectangle drawing canvas",
      "priority": 19,
      "passes": true,
      "description": "Replace the DOM element highlighting in SelectionMode with a canvas-based lasso rectangle drawing system like macOS Cmd+Shift+4.",
      "acceptanceCriteria": [
        "SelectionMode.tsx is rewritten to use a full-viewport canvas overlay",
        "Canvas has crosshair cursor and is transparent",
        "Mousedown starts drawing a rectangle from that point",
        "Mousemove while dragging draws rectangle with Sonance blue (#00A3E1) 2px border and 20% opacity fill",
        "Mouseup completes the rectangle and triggers screenshot capture of that region",
        "Completed rectangles show numbered badge (1, 2, 3...) at top-left corner",
        "Maximum 5 rectangles can be drawn (shows warning if exceeded)",
        "ESC key cancels current drawing and exits selection mode",
        "Done button exits selection mode",
        "Playwright test: entering selection mode shows canvas with crosshair cursor",
        "Playwright test: drawing rectangle (mousedown, mousemove, mouseup) creates visible selection",
        "Playwright test: ESC key exits selection mode",
        "npm run test:e2e passes",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-020",
      "title": "Screenshot list UI component",
      "priority": 20,
      "passes": true,
      "description": "Create ScreenshotList component to display captured screenshots as thumbnails in the feedback form, replacing ElementList.",
      "acceptanceCriteria": [
        "src/components/FeedbackWidget/ScreenshotList.tsx exists",
        "Component displays screenshots as 48x48px thumbnails in horizontal row",
        "Each thumbnail has numbered badge in corner (matching selection order)",
        "Each thumbnail has X button to remove that screenshot",
        "Clicking thumbnail shows larger preview (200px max dimension)",
        "'Clear all' button removes all screenshots",
        "Collapsed state shows 'X screenshots' badge",
        "Expanded state shows thumbnail grid",
        "Uses Sonance brand colors and styling",
        "Playwright test: after drawing rectangle, thumbnail appears in form",
        "Playwright test: clicking X on thumbnail removes it",
        "Playwright test: 'Clear all' removes all thumbnails",
        "npm run test:e2e passes",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-021",
      "title": "Supabase Storage upload function",
      "priority": 21,
      "passes": true,
      "description": "Add screenshot upload functionality to supabase.ts for storing captured screenshots in Supabase Storage.",
      "acceptanceCriteria": [
        "src/lib/supabase.ts exports uploadScreenshot(blob, appId, index) function",
        "Function uploads blob to 'feedback-screenshots' bucket",
        "Storage path format: {appId}/{timestamp}-{index}.png",
        "Function returns { url: string, storagePath: string } on success",
        "Function returns null on failure with console error",
        "Function handles missing Supabase client gracefully",
        "supabase/migrations/002_screenshots.sql exists with storage bucket creation SQL",
        "Unit test mocks Supabase client and verifies upload function interface",
        "npm run test passes",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-022",
      "title": "Replace element selection with screenshot capture in widget",
      "priority": 22,
      "passes": true,
      "description": "Update the main FeedbackWidget to use screenshot capture instead of DOM element selection. Replace all element-related state and logic with screenshot equivalents.",
      "acceptanceCriteria": [
        "selectedElements state replaced with capturedScreenshots state",
        "Selection mode captures lasso regions as screenshots instead of detecting DOM elements",
        "FeedbackForm uses ScreenshotList instead of ElementList",
        "Submit handler uploads screenshots to Supabase Storage before inserting feedback",
        "Feedback submission includes screenshots array with URLs instead of elements",
        "Badge overlay system updated for screenshot regions",
        "All element detection code removed from index.tsx",
        "Playwright test: full flow - open widget, draw region, see thumbnail, submit feedback",
        "Playwright test: submit without screenshots works",
        "Playwright test: submit with multiple screenshots works",
        "npm run test:e2e passes",
        "npm run build passes"
      ]
    },
    {
      "id": "STORY-023",
      "title": "Remove deprecated element selection files",
      "priority": 23,
      "passes": true,
      "description": "Clean up deprecated files that are no longer needed after switching to screenshot-based selection.",
      "acceptanceCriteria": [
        "src/components/FeedbackWidget/utils/elements.ts is deleted",
        "src/components/FeedbackWidget/ElementList.tsx is deleted",
        "All imports of elements.ts are removed",
        "All imports of ElementList.tsx are removed",
        "No TypeScript errors about missing files",
        "No dead code referencing element selection",
        "Old element-related unit tests removed or updated",
        "All existing Playwright tests still pass",
        "npm run test passes",
        "npm run test:e2e passes",
        "npm run build passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "STORY-024",
      "title": "Edge case and regression testing",
      "priority": 24,
      "passes": true,
      "description": "Add comprehensive edge case tests and ensure all regression tests pass for the lasso screenshot feature.",
      "acceptanceCriteria": [
        "Playwright test: drawing very small region (< 10px) shows warning and doesn't capture",
        "Playwright test: drawing 6th region shows max limit warning",
        "Playwright test: rapidly drawing multiple regions doesn't cause race conditions",
        "Playwright test: widget works correctly in all 4 corner positions",
        "Playwright test: selection mode works after form collapse/expand cycle",
        "Playwright test: screenshots persist when toggling selection mode on/off",
        "All unit tests pass: npm run test",
        "All E2E tests pass: npm run test:e2e",
        "npm run build passes",
        "npm run lint passes with no warnings"
      ]
    }
  ]
}
